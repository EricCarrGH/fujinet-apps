/**
 * @brief #FujiNet Reversi
 * @author  Thomas Cherryhomes
 * @email   thom dot cherryhomes at gmail dot com
 * @license gpl v. 3
 */

#include <conio.h>
#include <string.h>
#include <stdlib.h>
#include "csram.h"
#include "video.h"
#include "board.h"

unsigned char count_white, count_black;

/**
 * @brief board positions to check in color RAM
 */
unsigned short board_pos[64]=
    {
      25,27,29,31,33,35,37,39,
      69,71,73,75,77,79,81,83,
      113,115,117,119,121,123,125,127,
      157,159,161,163,165,167,169,171,
      201,203,205,207,209,211,213,215,
      245,247,249,251,253,255,257,259,
      289,291,293,295,297,299,301,303,
      333,335,337,339,341,343,345,347
    };

/**
 * @brief initial board video RAM
 */
char board_char[] =
  {
    0x20,0x20,0x41,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x48,0x20,0x20,
    
    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x4A,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x49,0x20,0x20    
  };

const char footer[]={0xA0,0xA0,0xA0,0xA3,0x86,0x95,0x8A,0x89,0x8E,0x85,0x94,0xA0,0x92,0x85,0x96,0x85,0x92,0x93,0x89,0xA0,0xA0,0xA0};

/**
 * @brief count # of pieces to white/black
 */
void board_count(void)
{
  unsigned char i;
  char tmp[4];
  count_white=
    count_black=0;
  
  for (i=0;i<64;i++)
    {
      unsigned char c = COLOR_RAM[board_pos[i]] & 0x0F; // Color ram is 4 bits wide, upper bits float.
      
      if (c==0x08)
	count_white++;
      else if (c==0x09)
	count_black++;
    }
}

/**
 * @brief place a piece on board
 * @param i board position to place piece
 * @param d Disc color
 */
void board_place_disc(unsigned char i, Disc d)
{
  unsigned short p = board_pos[i];
  char s[3];
  
  // Set the characters
  VIDEO_RAM[p]=0x3B;
  VIDEO_RAM[p+1]=0x3C;
  VIDEO_RAM[p+22]=0x3D;
  VIDEO_RAM[p+23]=0x3E;

  // Set the color
  COLOR_RAM[p]=
    COLOR_RAM[p+1]=
    COLOR_RAM[p+22]=
    COLOR_RAM[p+23]=d+7;

  // Update count, and display
  board_count();

  gotoxy(2,18);
  print("\x05tschak");
  gotoxy(18,18);
  itoa(count_white,s,10);
  print(s);
  gotoxy(2,19);
  print("\x90""mozzwald");
  gotoxy(18,19);
  itoa(count_black,s,10);
  print(s);
}

/**
 * @brief reset the board
 */
void board_reset(void)
{
  // Reset color ram
  memset(COLOR_RAM,0x0D,sizeof(board_char));

  // and place board background characters
  memcpy(VIDEO_RAM,board_char,sizeof(board_char));

  // Now place initial pieces
  board_place_disc(27,BLACK);
  board_place_disc(28,WHITE);
  board_place_disc(35,WHITE);
  board_place_disc(36,BLACK);

  // Place footer
  memcpy(&VIDEO_RAM[484],&footer[0],sizeof(footer));
  memset(&COLOR_RAM[484],0x00,sizeof(footer));
}

void main(void)
{
  unsigned char i;
  
  video_setup();

  // VIC.bg_border_color=216; // Light Green / Dark Green
  VIC.bg_border_color=88;
  VIC.volume_color=0x80;   // Orange aux color.

  clrscr();

  board_reset();
    
  while(1);
}
