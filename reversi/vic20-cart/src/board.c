/**
 * @brief #FujiNet Reversi
 * @author  Thomas Cherryhomes
 * @email   thom dot cherryhomes at gmail dot com
 * @license gpl v. 3
 */

#include <conio.h>
#include <string.h>
#include <stdlib.h>
#include <stdbool.h>
#include "csram.h"
#include "video.h"
#include "board.h"

unsigned char count_white, count_black;

/**
 * @brief board positions to check in color RAM
 */
unsigned short board_pos[64]=
    {
      25,27,29,31,33,35,37,39,
      69,71,73,75,77,79,81,83,
      113,115,117,119,121,123,125,127,
      157,159,161,163,165,167,169,171,
      201,203,205,207,209,211,213,215,
      245,247,249,251,253,255,257,259,
      289,291,293,295,297,299,301,303,
      333,335,337,339,341,343,345,347
    };

/**
 * @brief initial board video RAM
 */
char board_char[] =
  {
    0x20,0x20,0x41,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x48,0x20,0x20,
    
    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x3F,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x42,0x43,0x47,0x20,0x20,
    0x20,0x20,0x3F,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x44,0x45,0x47,0x20,0x20,

    0x20,0x20,0x4A,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x46,0x49,0x20,0x20    
  };

const char footer[]={0xA0,0xA0,0xA0,0xA3,0x86,0x95,0x8A,0x89,0x8E,0x85,0x94,0xA0,0x92,0x85,0x96,0x85,0x92,0x93,0x89,0xA0,0xA0,0xA0};

/**
 * @brief count # of pieces to white/black
 */
void board_count(void)
{
  unsigned char i;

  count_white=
    count_black=0;
  
  for (i=0;i<64;i++)
    {
      unsigned char c = COLOR_RAM[board_pos[i]] & 0x0F; // Color ram is 4 bits wide, upper bits float.
      
      if (c==0x08)
	count_white++;
      else if (c==0x09)
	count_black++;
    }
}

/**
 * @brief return disc at board position
 */
Disc board_get_disc(Position p)
{
  return COLOR_RAM[board_pos[p]] - COLOR_RAM_BIAS;
}

/**
 * @brief place a piece on board
 * @param i board position to place piece
 * @param d Disc color
 */
void board_place_disc(Position i, Disc d)
{
  unsigned short o = board_pos[i];
  char s[3];
  
  // Set the characters
  VIDEO_RAM[o]=DISC_CHAR_1;
  VIDEO_RAM[o+1]=DISC_CHAR_2;
  VIDEO_RAM[o+22]=DISC_CHAR_3;
  VIDEO_RAM[o+23]=DISC_CHAR_4;

  // Set the color
  COLOR_RAM[o]=
    COLOR_RAM[o+1]=
    COLOR_RAM[o+22]=
    COLOR_RAM[o+23]=d+COLOR_RAM_BIAS;

  // Update count, and display
  board_count();

  gotoxy(2,18);
  print("\x05tschak");
  gotoxy(18,18);
  itoa(count_white,s,10);
  print(s);
  gotoxy(2,19);
  print("\x90""mozzwald");
  gotoxy(18,19);
  itoa(count_black,s,10);
  print(s);
}

/**
 * @brief walk board
 * @param p board position
 * @param dx delta x
 * @param dy delta y
 * @param m my piece
 * @param o opponent piece
 * @return true = we can flip, otherwise false.
 */
bool walkBoard(Position p, signed char dx, signed char dy, Disc m, Disc o)
{
  
}

/**
 * @brief check for valid move
 * @param p board position
 * @param d Disc piece (WHITE | BLACK)
 */
void board_valid_move(Position p, Disc d)
{
  Disc opponent=WHITE;

  if (d == WHITE)
    d = BLACK;

  

  
}

/**
 * @brief reset the board
 */
void board_reset(void)
{
  // Reset color ram
  memset(COLOR_RAM,0x0D,sizeof(board_char));

  // and place board background characters
  memcpy(VIDEO_RAM,board_char,sizeof(board_char));

  // Now place initial pieces
  board_place_disc(START_POS_1,BLACK);
  board_place_disc(START_POS_2,WHITE);
  board_place_disc(START_POS_3,WHITE);
  board_place_disc(START_POS_4,BLACK);

  // Place footer
  memcpy(&VIDEO_RAM[FOOTER_OFFSET],&footer[0],sizeof(footer));
  memset(&COLOR_RAM[FOOTER_OFFSET],0x00,sizeof(footer));
}

void main(void)
{
  unsigned char i;
  
  video_setup();

  VIC.bg_border_color=88;  // Green with black border
  VIC.volume_color=0x80;   // Orange aux color.

  clrscr();

  board_reset();
    
  while(1);
}
